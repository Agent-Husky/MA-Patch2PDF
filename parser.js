var filecontent,filename;function readFile(){const[a]=document.querySelector("input[type=file]").files,b=new FileReader;b.addEventListener("load",()=>{if("text/csv"===a.type)filecontent=parseCSV(b.result,a.name);else if("text/xml"===a.type)parser=new DOMParser,xmlDoc=parser.parseFromString(b.result,"text/xml"),0<xmlDoc.getElementsByTagName("MA").length&&xmlDoc.getElementsByTagName("MA")[0].attributes.xmlns.value.includes("grandma2")?filecontent=parseMA2XML(xmlDoc,a.name):0<xmlDoc.getElementsByTagName("GMA3").length;else if("application/json"===a.type){if(filecontent=JSON.parse(b.result),"GMA3"!=filecontent.Version)return;filecontent.exportTime=new Date(filecontent.exportTime).toLocaleString()}filecontent&&(document.getElementById("pdfgen").style.display="",filename=a.name,loadperlayerconfig(filecontent.data))},!1),a&&b.readAsText(a)}function parseCSV(a,b){var c={},d={};return lines=a.replace(/\"/g,"").split("\n"),headers=lines[0].split(";"),layerlistpos=headers.indexOf("Layer"),headers[headers.indexOf("Fix ID")]="FixtureID",headers[headers.indexOf("Ch ID")]="ChannelID",layerindex=1,lines.shift(),lines=lines.filter(function(a){return""!=a}),lines.forEach(function(a){rowelements=a.split(";"),layer=rowelements.splice(layerlistpos,1),temp={},rowelements.forEach(function(a,b){temp[headers[b+1]]=a}),"undefined"==typeof d[layer]&&(d[layer]={},d[layer].index=layerindex++),"undefined"==typeof d[layer].data&&(d[layer].data=[]),d[layer].data.push(temp)}),c.showname=b.replace(/\.[^/.]+$/,""),c.exportTime=new Date().toLocaleString(),c.data=d,c}function parseMA2XML(a,b){var c={},d={};layers=a.getElementsByTagName("Layer");for(let c of layers){"undefined"==typeof d[c]&&(d[c.attributes.name.value]={},d[c.attributes.name.value].data=[],d[c.attributes.name.value].index=+c.attributes.index.value),fixtures=c.getElementsByTagName("Fixture");for(let a of fixtures)subfixtures=a.getElementsByTagName("SubFixture"),patch=getPatch(subfixtures),null!==patch&&(temp={},temp.FixtureID=returnIfDefined(a.attributes.fixture_id),temp.ChannelID=returnIfDefined(a.attributes.channel_id,"."+(+subfixtures[0].attributes.index.value+1)),temp.Name=returnIfDefined(a.attributes.name),fixtype=a.getElementsByTagName("FixtureType")[0],temp.FixtureType=returnIfDefined(fixtype.attributes.name),temp.Patch=patch,temp.DipPatch=getDipPatch(subfixtures),temp.Position=getPosition(subfixtures),temp.Color=subfixtures[0].attributes.color.value,d[c.attributes.name.value].data.push(temp))}return c.showname=b.replace(/\.[^/.]+$/,""),c.exportTime=new Date(a.getElementsByTagName("Info")[0].attributes.datetime.value).toLocaleString(),c.data=d,c}function parseMA3XML(a){var b={};layers=a.getElementsByTagName("GMA3")[0].children;for(let c of layers){"undefined"==typeof b[c]&&(b[c.attributes.Name.value]={},b[c.attributes.Name.value].data=[],b[c.attributes.Name.value].index=+c.attributes.FID.value),fixtures=c.getElementsByTagName("Fixture");for(let a of fixtures)subfixtures=a.getElementsByTagName("SubFixture"),console.log(a),patch=a.attributes.Patch.value,null!==patch&&(temp={},temp.FixtureID=returnIfDefined(a.attributes.FID),temp.ChannelID=null,temp.Name=returnIfDefined(a.attributes.name),temp.Patch=patch,temp.Position=getPosition(subfixtures),b[c.attributes.Name.value].data.push(temp))}return b}function returnIfDefined(a,b=""){return"undefined"==typeof a?null:a.value+b}function getAddress(a){let b;if(1===a.length)b=+a[0].getElementsByTagName("Address")[0].textContent;else{let c=[];for(let b of a)c.push(+b.getElementsByTagName("Address")[0].textContent);b=Math.min(...c)}return b}function getPatch(a){let b=getAddress(a);return 0===b?null:Math.ceil(b/512)+"."+("000"+(0==b%512?512:b%512)).slice(-3)}function getDipPatch(a){let b=getAddress(a);return 0===b?null:(b=0==b%512?512:b%512,dips=getAllIndexes(b.toString(2).split("").reverse(),"1"),dipstring="",dips.forEach(function(a,b){dipstring+=a+1,dipstring+=b===dips.length-1?"":","}),dipstring)}function getMiddle(a){return sum=a.reduce((c,a)=>c+a,0),+(sum/a.length).toFixed(2)}function getPosition(a){let b={};if(1===a.length)abspos=a[0].getElementsByTagName("AbsolutePosition")[0],"undefined"!=typeof abspos&&(abslocation=abspos.getElementsByTagName("Location")[0],b.x=abslocation.attributes.x.value,b.y=abslocation.attributes.y.value,b.z=abslocation.attributes.z.value);else{xarray=[],yarray=[],zarray=[],positions=[];for(let b of a)if(abspos=b.getElementsByTagName("AbsolutePosition")[0],"undefined"!=typeof abspos)absposattr=abspos.getElementsByTagName("Location")[0].attributes,xarray.push(+absposattr.x.value),yarray.push(+absposattr.y.value),zarray.push(+absposattr.z.value);else continue;b.x=getMiddle(xarray),b.y=getMiddle(yarray),b.z=getMiddle(zarray)}return"undefined"==typeof b.x&&(b.x=null),"undefined"==typeof b.y&&(b.y=null),"undefined"==typeof b.z&&(b.z=null),b}function getAllIndexes(a,b){var c,d=[];for(c=0;c<a.length;c++)a[c]===b&&d.push(c);return d}function loadperlayerconfig(a){Object.keys(a).forEach(a=>{layerdiv=document.createElement("div"),layerdiv.classList.add("layerconfig"),layertext=document.createElement("p"),layertext.innerHTML=a,layertext.classList.add("layerconfigheader"),table=document.createElement("table"),table.appendChild(document.createElement("tr")),table.appendChild(document.createElement("tr")),console.log(table),tablerows=table.getElementsByTagName("tr"),defaultTableHeaders.forEach((b,c)=>{th=document.createElement("th"),th.innerHTML=b.name,td=document.createElement("td"),label=document.createElement("label"),label.classList.add("switch"),chkbx=document.createElement("input"),chkbx.type="checkbox",chkbx.name=a,chkbx.value=c,chkbx.checked=b.enabled,label.appendChild(chkbx),slider=document.createElement("span"),slider.classList.add("slider"),slider.classList.add("round"),label.appendChild(slider),td.appendChild(label),tablerows[0].appendChild(th),tablerows[1].appendChild(td)}),layerdiv.appendChild(layertext),layerdiv.appendChild(table),document.getElementById("perlayerconfig").appendChild(layerdiv)})}